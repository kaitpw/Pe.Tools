<core:RevitHostedUserControl x:Class="Pe.Ui.Components.Palette"
                             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                             xmlns:local="clr-namespace:Pe.Ui.Components"
                             xmlns:core="clr-namespace:Pe.Ui.Core"
                             VerticalAlignment="Top">
    <!-- Outer Grid: Transparent container for independent palette/panel backgrounds -->
    <Grid HorizontalAlignment="Stretch"
          VerticalAlignment="Top">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition x:Name="SidebarColumn" Width="0" />
        </Grid.ColumnDefinitions>

        <!-- PALETTE SIDE: Own background, shadow, and rounded corners -->
        <Border x:Name="PaletteBackground"
                Grid.Column="0"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Top"
                CornerRadius="8"
                ClipToBounds="True"
                Background="{ui:ThemeResource ApplicationBackgroundBrush}">
            <Border.Effect>
                <DropShadowEffect Color="Black" Direction="270" ShadowDepth="2" BlurRadius="12" Opacity="0.5" />
            </Border.Effect>
            
            <!-- Main palette content -->
            <Grid x:Name="PaletteContentGrid"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Top">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Title Bar with Tabs -->
                <Border x:Name="TitleBarBorder"
                        Grid.Row="0"
                        Padding="12,8,12,6">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <!-- Title on the left -->
                        <ui:TextBlock x:Name="TitleText"
                                      Grid.Column="0"
                                      Text="Palette"
                                      FontSize="16"
                                      FontWeight="SemiBold"
                                      VerticalAlignment="Center"
                                      Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" />
                        
                        <!-- Tab Bar on the right (hidden when no tabs) -->
                        <Border x:Name="TabBarBorder"
                                Grid.Column="2"
                                Visibility="Collapsed"
                                Background="Transparent">
                            <ItemsControl x:Name="TabBarItemsControl">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </Border>
                    </Grid>
                </Border>

                <!-- Search Box with Filter -->
                <Border x:Name="SearchBoxBorder"
                        Grid.Row="1"
                        ClipToBounds="True"
                        Background="Transparent">
                    <Grid x:Name="SearchBoxGrid"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Center">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <ui:TextBox x:Name="SearchTextBox"
                                    Grid.Column="0"
                                    Style="{StaticResource TransparentTextBoxStyle}"
                                    Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                            <ui:TextBox.InputBindings>
                                <KeyBinding Key="Down" Command="{Binding MoveSelectionDownCommand}" />
                                <KeyBinding Key="Up" Command="{Binding MoveSelectionUpCommand}" />
                            </ui:TextBox.InputBindings>
                        </ui:TextBox>

                        <!-- FilterBox will be added programmatically to Grid.Column="1" -->
                    </Grid>
                </Border>

                <!-- Item List - MaxHeight set dynamically in code based on DefaultVisibleItems -->
                <Border Grid.Row="2" 
                        Padding="4,0,4,0">
                    <local:ListView x:Name="ItemListView"
                                    ItemsSource="{Binding FilteredItems}"
                                    SelectedItem="{Binding SelectedItem}"
                                    SelectedIndex="{Binding SelectedIndex}" />
                </Border>

                <!-- Status Bar -->
                <Border x:Name="StatusBarBorder"
                        Grid.Row="3"
                        Background="{ui:ThemeResource CardBackgroundFillColorSecondaryBrush}">
                    <Grid x:Name="StatusBarGrid">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <ui:TextBlock x:Name="ItemCountText"
                                      Grid.Column="0"
                                      Text="{Binding FilteredItems.Count, StringFormat=\{0\} items}"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Left"
                                      FontSize="12"
                                      Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" />

                        <ui:TextBlock x:Name="HelpText"
                                      Grid.Column="1"
                                      Text="↑↓ Navigate • ← Tooltip • → Actions • Click/Enter Execute • Esc Close"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Right"
                                      FontSize="10"
                                      Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" />

                        <!-- Tray Toggle Button -->
                        <ui:Button x:Name="TrayToggleButton"
                                   Grid.Column="2"
                                   Padding="4"
                                   Margin="4,0,0,0"
                                   Appearance="Secondary"
                                   BorderThickness="0"
                                   Visibility="Collapsed"
                                   ToolTip="Show/Hide Options">
                            <ui:SymbolIcon x:Name="TrayToggleIcon" Symbol="ChevronDown20" FontSize="12" />
                        </ui:Button>
                    </Grid>
                </Border>

                <!-- Pull-Down Tray (collapsible) -->
                <Border x:Name="TrayBorder"
                        Grid.Row="4"
                        Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderThickness="0,1,0,0"
                        BorderBrush="{ui:ThemeResource ControlStrokeColorDefaultBrush}"
                        MaxHeight="0"
                        ClipToBounds="True">
                    <ScrollViewer VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Disabled"
                                  Padding="12,8,12,8">
                        <ContentControl x:Name="TrayContent" />
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>

        <!-- PANEL SIDE: Own background, shadow, and rounded corners (initially collapsed) -->
        <!-- MaxHeight set dynamically in code to match palette height -->
        <Border x:Name="PanelBackground"
                Grid.Column="1"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Top"
                CornerRadius="8"
                ClipToBounds="True"
                BorderThickness="1,0,0,0"
                BorderBrush="{ui:ThemeResource ControlStrokeColorDefaultBrush}"
                Background="{ui:ThemeResource ApplicationBackgroundBrush}">
            <Border.Effect>
                <DropShadowEffect Color="Black" Direction="270" ShadowDepth="2" BlurRadius="12" Opacity="0.5" />
            </Border.Effect>
            
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                
                <!-- Panel Header with expand button -->
                <Border Grid.Row="0" 
                        Padding="12,8,8,4"
                        BorderThickness="0,0,0,1"
                        BorderBrush="{ui:ThemeResource ControlStrokeColorDefaultBrush}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <ui:TextBlock x:Name="PanelTitle"
                                      Grid.Column="0"
                                      Text="Details"
                                      VerticalAlignment="Center"
                                      FontSize="12"
                                      FontWeight="SemiBold"
                                      Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" />
                        
                        <ui:Button x:Name="ExpandPanelButton"
                                   Grid.Column="1"
                                   Padding="4"
                                   Appearance="Secondary"
                                   BorderThickness="0"
                                   ToolTip="Expand panel">
                            <ui:SymbolIcon Symbol="ArrowMaximize20" FontSize="14" />
                        </ui:Button>
                    </Grid>
                </Border>
                
                <!-- Panel Content - FontSize 13 for better readability of table data -->
                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              Padding="12,8,12,12"
                              FontSize="13">
                    <ContentControl x:Name="SidebarContent" />
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</core:RevitHostedUserControl>
